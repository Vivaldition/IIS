## Цель работы 

 Настройка окружения и разведочный анализ данных. 

 Подготовить структуру проекта и провести разведочный анализ данных. Результаты первой лабораторной работы будут использоваться в дальнейшем цикле работ.

## Описание проекта

 Цена автомобиля зависит от множества факторов, таких как репутация марки, характеристики автомобиля, мощность двигателя, пробег и многое другое. Прогнозирование цен на автомобили — одно из основных направлений исследований в области машинного обучения. <br/>
 Данный проект анправлен на прогнозирование стоимости подержанных автомобилей.<br/>
 Датасет можно скачать по ссылке: https://www.kaggle.com/datasets/vijayaadithyanvg/car-price-predictionused-cars/data <br/>
## Структура проекта
```
 car_price_pred
 |_____ .venv_car_price_pred (виртуальное окружение) 
 |_____ .git 
 |_____ data (исходные данные ) 
 |       |___ car_data.csv (датасет стоимостей подержанных автомобилей) 
 |       |___ clean_car_data.pkl (очищенный датасет стоимостей подержанных автомобилей)
 |
 |_____ eda
 |       |___ eda.ipynb (файл jupyter notebook с анализом данных) 
 |       |___ цены_машин.png (картинки графика полученного в ходе анализа цен на машины по их количеству) 
 |       |___ цена_и_год.png (картинка графика полученного в ходе анализа цены на машину от года ее изготовления) 
 |       |___ корреляционная_матрица.png (картинка тепловой карты корреляции) 
 |       |___ цена_по_типам_топлива.png (картинка диаграммы Тьюки по топливу) 
 |       |___ цена_от_пробега.png (картинка графика полученного в ходе анализа цены от пробега автомобиля) 
 |
 |_____ mlflow (содержит всё, что связано с фреймворком MLflow для отслеживания экспериментов)
 |       |___ Модели.jpg (Скриншот зарегистрированных версий моделей)
 |       |___ Графики с метриками.jpg(Скриншот всех прогонов и их графиков с метриками качества)
 |       |___ start_mlflow.sh (bash-скрипт для запуска локального сервера MLflow)
 |       |___ mlruns.db (база данных SQLite для хранения метаданных экспериментов)
 |_____ research (храниться артефакты по настройке модели)
 |       |___ research.ipynb (блокнот с исследованием моделей и экспериментов)
 |       |___ sfs_idx.txt (файл с индексами столбцов наиболее важных признаков)
 |       |___ sfs_cols.txt (файл с названиями столбцов наиболее важных признаков)
 │
 |_____services
 │       |___ ml_service                  
 │       │     ├── Dockerfile (Dockerfile для ML-сервиса)
 │       │     ├── api_handler.py (Обработчик API запросов)
 │       │     ├── main.py  (Основной файл FastAPI приложения)
 │       │     └── requirements.txt (Зависимости ML-сервиса)
 │       │
 │       |___ models          
 │       │     └── get_prod_model.py (Скрипт для получения продакшен модели из MLflow)
 │       ├── prometheus                  
 │       │     ├── prometheus.yml  (Конфигурация Prometheus)
 │       │     ├── График в prometheus 1.png (Гистограмма предсказаний модели)
 │       │     ├── График в prometheus 2.png (Частота запросов к сервису)
 │       │     └── График в prometheus 3.png (Коды ошибок)
 │       ├── requests                    
 │       │      ├── grafana                      
 │       │      │     ├── dashboard.json (Конфигурация дашборда Grafana)
 │       │      │     ├── Графики в grafana 1.png (Скриншот дашборда 1)
 │       │      │     └── Графики в grafana 2.png (Скриншот дашборда 2)
 │       │      │     
 │       │      ├── requests.py (Скрипты для тестирования запросов)
 │       │      └── Dockerfile  (Dockerfile для сервиса тестирования)
 │       |___docker-compose.yml
 │
 |_____ .gitignore (файл с правилами проекта) 
 |_____ README.md (файл с описанием проекта) 
 |_____ requirements.txt (файл с библиотеками, использующимися в проекте)
 


 ```


## Запуск проекта

```
git clone https://github.com/Vivaldition/IIS
``` 
```
cd IIS
```
```
python3 -m venv # установка окружения
```
```
source .venv/bin/activate # активация окружения
```
```
pip install -r requirements.txt # установка зависимостей
```

## Исследование данных
Находится в ./eda/eda.ipynb.

### Основные результаты:

В ходе исследования были проведены действия:

• Загрузка данных: df = pd.read_csv('../data/car_data.csv') <br/>
• Была сделана проверка на дубликаты и отсутствие значений:df.duplicated().sum(), df.isnull().sum(). Было обнаружено два дублика, которые были удалены <br/> 
• Был создан новый признак df['Car_Age'] = 2025 - df['Year']  # Возраст автомобиля в годах <br/>

Обработанная выборка сохранена в файле ./data/clean_car_data.pkl

## Графики

### 1. График распределения цен

![image](https://github.com/Vivaldition/IIS/blob/main/eda/цены_машин.png)

На данном графике представлена зависимость стоимости машин от их количества. По оси абцисс находится цена за машину, которая измеряется в "lakhs", а по оси ординат находится кол-во машин, которые продаются по определенной цене.

### Вывод: Большинство машин имеет стоимость ниже или равную 10 lakhs, помимо этого присутствуют и дорогие варианты машин

### 2. График цена и год выпуска

![image](https://github.com/Vivaldition/IIS/blob/main/eda/%D1%86%D0%B5%D0%BD%D0%B0_%D0%B8_%D0%B3%D0%BE%D0%B4.png)

На графике представлена зависимость цены машины от года выпуска. По оси ординат находится цена за машину, которая измеряется в "lakhs", а по оси абцисс находится год выпуска машины.

### Вывод: Исходя из графика можно сделать вывод, что машины имеющие дизельный двигатель внутреннего сгорания стоят дороже, нежели машины на природном газе и машины на бензине. Также по графику видно, что чем новее машина, тем она дороже.

### 3. Корреляционная матрица

![image](https://github.com/Vivaldition/IIS/blob/main/eda/корреляционная_матрица.png)

На графике представлена тепловая карта корреляции. <br/>


### Вывод: Из матрицы корреляции видно, что год выпуска и текущая стоимость (Present_Price) сильно влияет- новые машины дороже и имеют наименьший пробег. Пробег (Driven_kms) и (Owner) оказывают слабое влияние на цену.

### 4. Диаграмма Тьюки цены по типу топлива

![image](https://github.com/Vivaldition/IIS/blob/main/eda/цена_по_типам_топлива.png)


### Вывод: Из диаграммы Тьюки видно, что машины работающие на дизеле стоят дороже

### 5. График зависимости цены от пробега автомобиля


![image](https://github.com/Vivaldition/IIS/blob/main/eda/цена_от_пробега.png)

### Вывод: Из графика видно, что машины, которые имеют минимальный пробег, имеют наибольшую цену. А машины, у которых пробег потихоньку дотягивать или переваливать за 100.000 км, цена снижается

## Общие выводы:

- Год выпуска сильно влияет на цену: чем новее машины, тем выше у нее цена
- Дизельные машины дороже бензиновых и газовых
- Пробег слабо влияет на стоимость автомобиля
- Автоматические КПП увеличивают стоимость машины, так как на них ездить комфортнее
- Car_Age: возраст автомобиля в годах

## Запуск проекта MLFlow

```
cd mlflow
```
```
sh start_mlflow.sh
```
## Проведенные эксперименты

В ходе исследования были последовательно протестированы следующие подходы:

- **Baseline-модель** - базовая модель без дополнительных преобразований признаков
- **Модель с расширенным набором признаков** - с использованием PolynomialFeatures, QuantileTransformer и SplineTransformer
- **Модель с отбором признаков** - с применением Sequential Feature Selection для выбора наиболее значимых признаков

Наилучшие результаты показала модель с Sequential Feature Selection, которая была дополнительно оптимизирована с помощью фреймворка Optuna.

## Анализ результатов

### Сравнительная эффективность моделей
Модель с Sequential Feature Selection продемонстрировала наивысшее качество до тонкой настройки гиперпараметров:
- **MAE**: 0.47
- **MSE**: 0.81
- **MAPE**: 0.16

## Оптимальная конфигурация модели
В результате подбора гиперпараметров с использованием Optuna были определены следующие оптимальные значения:
- **max_depth**: 10
- **n_estimators**: 57
- **max_features**: 0.189
- **min_samples_split**: 2
- **min_samples_leaf**: 1

## Финальные метрики качества
После применения подобранных гиперпараметров достигнуты следующие показатели:
- **MAE**: 0.2343
- **MSE**: 0.2324
- **MAPE**: 0.0780

Идентификатор Production-модели в MLflow: `604afa9bb6164f78bc2268efa58d1794`

# Создание сервиса

### 1. Основной API-сервер с FastAPI

**Реализованные эндпоинты:**
- **GET /** - возвращает сообщение `{'Hello': 'world'}` для проверки работоспособности <br/>
- **POST /api/prediction** - принимает характеристики автомобиля и используя модель для предсказания и возвращает предсказанную цену на данны автомобиль  <br/>

### 2. Обработчик предсказаний модели

**Класс ModelHandler:**
- При создании экземпляра класса загружает модель из файла `car_price_model.pkl` <br/>
- Логирует успешность загрузки или ошибки <br/>
- Метод `predict` принимает словарь с признаками автомобиля, преобразует его в pandas.DataFrame, подает на вход модели и возвращает предсказанную цену <br/>

### 3. Dockerfile для контейнеризации сервиса

```dockerfile
﻿FROM python:3.11-slim
WORKDIR /app
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY services/ml_service/ .
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**Особенности:**
- Копирование всех файлов приложения в контейнер <br/>
- Установка зависимостей из `requirements.txt` <br/>
- Указание рабочей директории и порта для запуска <br/>
- Обеспечение возможности подключения модели через монтируемую папку (`/models`) <br/>
- Запуск приложения с помощью uvicorn <br/>

### 4. Зависимости проекта (requirements.txt)

```txt
numpy==1.26.4
pandas==2.3.3
matplotlib==3.10.7
plotly==6.3.1
seaborn==0.13.2
scikit-learn==1.7.2
mlflow==3.5.1
optuna
fastapi
uvicorn
```

### 5. Интеграция с MLflow

**Назначение:**
- Загружаем модель из с MLflow <br/>
- Сохраняет модель в файл `car_price_model.pkl` для дальнейшего использования <br/>


### 6. Проверка работоспособности сервиса

**Пример тестового запроса:**
```python
{
    "Car_Name": "Honda City",
    "Year": 2018,
    "Present_Price": 8.2,
    "Driven_kms": 42000,
    "Fuel_Type": "Petrol",
    "Selling_type": "Dealer", 
    "Transmission": "Manual",
    "Owner": 0
}
```

**Ожидаемый ответ:**
```python
{
    "predicted_price": 6.8,
    "status": "success"
}
```

Сервис возвращает значение predicted_price, что позволяет определить цену на данный автомобиль.

## Мониторинг

### 1. Prometheus

**Настройка:**
- Веб-интерфейс доступен по адресу: http://localhost:9090 <br/>
- Конфигурационный файл: `/services/prometheus/prometheus.yml` <br/>
- Полученные скриншоты и файл конфигурации размещены в директории: `/services/prometheus` <br/>

**Ключевые метрики:**

**Гистограмма предсказаний модели**
![Гистограмма предсказаний](https://github.com/Vivaldition/IIS/blob/main/services/prometheus/%D0%93%D1%80%D0%B0%D1%84%D0%B8%D0%BA%20%D0%B2%20prometheus%201.png) <br/>

**Частота (rate) запросов к основному сервису в минуту**
![Частота запросов](https://github.com/Vivaldition/IIS/blob/main/services/prometheus/%D0%93%D1%80%D0%B0%D1%84%D0%B8%D0%BA%20%D0%B2%20prometheus%202.png) <br/>

**Количество запросов к сервису с кодами ошибок 4** и 5**
![Коды ошибок](https://github.com/Vivaldition/IIS/blob/main/services/prometheus/%D0%93%D1%80%D0%B0%D1%84%D0%B8%D0%BA%20%D0%B2%20prometheus%203.png) <br/>

### 2. Grafana Dashboard

**Настройка:**
- Создан дашборд для мониторинга метрик, который сохранён в директории: `/services/requests/grafana` <br/>
- Веб-интерфейс Grafana доступен по адресу: http://localhost:3000 <br/>
- В качестве источника данных (database) используется сервис Prometheus <br/>

![Дашборд Grafana 1](https://github.com/Vivaldition/IIS/blob/main/services/requests/grafana/%D0%93%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B8%20%D0%B2%20grafana%201.png) <br/>
![Дашборд Grafana 2](https://github.com/Vivaldition/IIS/blob/main/services/requests/grafana/%D0%93%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B8%20%D0%B2%20grafana%202.png) <br/>
![Дашборд Grafana 3](https://github.com/Vivaldition/IIS/blob/main/services/requests/grafana/График%20в%20grafana%203.png) <br/>

**Панели дашборда:**

**Панель 1 - Request Rate per Minute**
- **Визуализация**: Количество HTTP-запросов в минуту к различным эндпоинтам
- **Метрики**: Rate запросов к `/api/prediction` (POST) и `/metrics` (GET)
- **Назначение**: Мониторинг нагрузки на API и частоты использования сервиса
- **Уровень**: Прикладной

**Панель 2 - Error Rate (4xx/5xx)**
- **Визуализация**: Частота ошибок HTTP с кодами 4xx и 5xx
- **Метрики**: Количество запросов с ошибками клиента (4xx) и сервера (5xx)
- **Назначение**: Контроль стабильности работы API и выявление проблем
- **Уровень**: Прикладной

**Панель 3 - Total Predictions**
- **Визуализация**: Общее количество выполненных предсказаний
- **Метрики**: Суммарное число успешных прогнозов модели
- **Назначение**: Отслеживание объема работы ML-модели
- **Уровень**: Качество ML-модели
 
**Панель 4 - Prediction Value Distribution**
- **Визуализация**: Распределение значений предсказаний по диапазонам
- **Метрики**: Гистограмма предсказанных цен с различными порогами (le)
- **Назначение**: Анализ распределения результатов работы модели
- **Уровень**: Качество ML-модели

**Панель 5 - Car Price Prediction Service - CPU Usage**
- **Визуализация: Потребление процессорного времени сервисом прогнозирования цен**
- **Метрики: Количество секунд CPU времени, использованных процессом**
- **Назначение: Мониторинг вычислительной нагрузки и потребления ресурсов сервисом**
- **Уровень: Инфраструктурный**

## Запуск системы

### 1. Команды для запуска

```bash
# Сборка образа
docker build . --tag car_price_model:1

# Запуск compose-проекта
docker compose up
```

### 2. Доступные сервисы

- **Основной сервис**: http://localhost:8000
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000

 
