## Цель работы 

 Настройка окружения и разведочный анализ данных. 

 Подготовить структуру проекта и провести разведочный анализ данных. Результаты первой лабораторной работы будут использоваться в дальнейшем цикле работ.

## Описание проекта

 Цена автомобиля зависит от множества факторов, таких как репутация марки, характеристики автомобиля, мощность двигателя, пробег и многое другое. Прогнозирование цен на автомобили — одно из основных направлений исследований в области машинного обучения. <br/>
 Данный проект анправлен на прогнозирование стоимости подержанных автомобилей.<br/>
 Датасет можно скачать по ссылке: https://www.kaggle.com/datasets/vijayaadithyanvg/car-price-predictionused-cars/data <br/>
## Структура проекта
```
 car_price_pred
 |_____ .venv_car_price_pred (виртуальное окружение) 
 |_____ .git 
 |_____ data (исходные данные ) 
 |       |___ car_data.csv (датасет стоимостей подержанных автомобилей) 
 |       |___ clean_car_data.pkl (очищенный датасет стоимостей подержанных автомобилей)
 |
 |_____ eda
 |       |___ eda.ipynb (файл jupyter notebook с анализом данных) 
 |       |___ цены_машин.png (картинки графика полученного в ходе анализа цен на машины по их количеству) 
 |       |___ цена_и_год.png (картинка графика полученного в ходе анализа цены на машину от года ее изготовления) 
 |       |___ корреляционная_матрица.png (картинка тепловой карты корреляции) 
 |       |___ цена_по_типам_топлива.png (картинка диаграммы Тьюки по топливу) 
 |       |___ цена_от_пробега.png (картинка графика полученного в ходе анализа цены от пробега автомобиля) 
 |
 |_____ mlflow (содержит всё, что связано с фреймворком MLflow для отслеживания экспериментов)
 |       |___ Модели.jpg (Скриншот зарегистрированных версий моделей)
 |       |___ Графики с метриками.jpg(Скриншот всех прогонов и их графиков с метриками качества)
 |       |___ start_mlflow.sh (bash-скрипт для запуска локального сервера MLflow)
 |       |___ mlruns.db (база данных SQLite для хранения метаданных экспериментов)
 |_____ research (храниться артефакты по настройке модели)
 |       |___ research.ipynb (блокнот с исследованием моделей и экспериментов)
 |       |___ sfs_idx.txt (файл с индексами столбцов наиболее важных признаков)
 |       |___ sfs_cols.txt (файл с названиями столбцов наиболее важных признаков)
 │
 |_____services
 │        └── ml_service                  
 │            ├── Dockerfile (Dockerfile для ML-сервиса)
 │            ├── api_handler.py (Обработчик API запросов)
 │            ├── main.py  (Основной файл FastAPI приложения)
 │            └── requirements.txt (Зависимости ML-сервиса)
 │
 ├── models          
 │        └── get_prod_model.py (Скрипт для получения продакшен модели из MLflow)
 ├── prometheus                  
 │   ├── prometheus.yml  (Конфигурация Prometheus)
 │   ├── График в prometheus 1.png (Гистограмма предсказаний модели)
 │   ├── График в prometheus 2.png (Частота запросов к сервису)
 │   └── График в prometheus 3.png (Коды ошибок)
 │
 ├── grafana                      
 │   ├── dashboard.json (Конфигурация дашборда Grafana)
 │   ├── Графики в grafana 1.png (Скриншот дашборда 1)
 │   ├── Графики в grafana 2.png (Скриншот дашборда 2)
 │   └── Dockerfile (Dockerfile для Grafana)
 │
 └── requests                    
 │   ├── requests.py (Скрипты для тестирования запросов)
 │   └── Dockerfile  (Dockerfile для сервиса тестирования)
 |_____ .gitignore (файл с правилами проекта) 
 |_____ README.md (файл с описанием проекта) 
 |_____ requirements.txt (файл с библиотеками, использующимися в проекте)
 


 ```


## Запуск проекта

```
git clone https://github.com/Vivaldition/IIS
``` 
```
cd IIS
```
```
python3 -m venv # установка окружения
```
```
source .venv/bin/activate # активация окружения
```
```
pip install -r requirements.txt # установка зависимостей
```

## Исследование данных
Находится в ./eda/eda.ipynb.

### Основные результаты:

В ходе исследования были проведены действия:

• Загрузка данных: df = pd.read_csv('../data/car_data.csv') <br/>
• Была сделана проверка на дубликаты и отсутствие значений:df.duplicated().sum(), df.isnull().sum(). Было обнаружено два дублика, которые были удалены <br/> 
• Был создан новый признак df['Car_Age'] = 2025 - df['Year']  # Возраст автомобиля в годах <br/>

Обработанная выборка сохранена в файле ./data/clean_car_data.pkl

## Графики

### 1. График распределения цен

![image](https://github.com/Vivaldition/IIS/blob/main/eda/цены_машин.png)

На данном графике представлена зависимость стоимости машин от их количества. По оси абцисс находится цена за машину, которая измеряется в "lakhs", а по оси ординат находится кол-во машин, которые продаются по определенной цене.

### Вывод: Большинство машин имеет стоимость ниже или равную 10 lakhs, помимо этого присутствуют и дорогие варианты машин

### 2. График цена и год выпуска

![image](https://github.com/Vivaldition/IIS/blob/main/eda/%D1%86%D0%B5%D0%BD%D0%B0_%D0%B8_%D0%B3%D0%BE%D0%B4.png)

На графике представлена зависимость цены машины от года выпуска. По оси ординат находится цена за машину, которая измеряется в "lakhs", а по оси абцисс находится год выпуска машины.

### Вывод: Исходя из графика можно сделать вывод, что машины имеющие дизельный двигатель внутреннего сгорания стоят дороже, нежели машины на природном газе и машины на бензине. Также по графику видно, что чем новее машина, тем она дороже.

### 3. Корреляционная матрица

![image](https://github.com/Vivaldition/IIS/blob/main/eda/корреляционная_матрица.png)

На графике представлена тепловая карта корреляции. <br/>


### Вывод: Из матрицы корреляции видно, что год выпуска и текущая стоимость (Present_Price) сильно влияет- новые машины дороже и имеют наименьший пробег. Пробег (Driven_kms) и (Owner) оказывают слабое влияние на цену.

### 4. Диаграмма Тьюки цены по типу топлива

![image](https://github.com/Vivaldition/IIS/blob/main/eda/цена_по_типам_топлива.png)


### Вывод: Из диаграммы Тьюки видно, что машины работающие на дизеле стоят дороже

### 5. График зависимости цены от пробега автомобиля


![image](https://github.com/Vivaldition/IIS/blob/main/eda/цена_от_пробега.png)

### Вывод: Из графика видно, что машины, которые имеют минимальный пробег, имеют наибольшую цену. А машины, у которых пробег потихоньку дотягивать или переваливать за 100.000 км, цена снижается

## Общие выводы:

- Год выпуска сильно влияет на цену: чем новее машины, тем выше у нее цена
- Дизельные машины дороже бензиновых и газовых
- Пробег слабо влияет на стоимость автомобиля
- Автоматические КПП увеличивают стоимость машины, так как на них ездить комфортнее
- Car_Age: возраст автомобиля в годах

## Запуск проекта MLFlow

```
cd mlflow
```
```
sh start_mlflow.sh
```
## Проведенные эксперименты

В ходе исследования были последовательно протестированы следующие подходы:

- **Baseline-модель** - базовая модель без дополнительных преобразований признаков
- **Модель с расширенным набором признаков** - с использованием PolynomialFeatures, QuantileTransformer и SplineTransformer
- **Модель с отбором признаков** - с применением Sequential Feature Selection для выбора наиболее значимых признаков

Наилучшие результаты показала модель с Sequential Feature Selection, которая была дополнительно оптимизирована с помощью фреймворка Optuna.

## Анализ результатов

### Сравнительная эффективность моделей
Модель с Sequential Feature Selection продемонстрировала наивысшее качество до тонкой настройки гиперпараметров:
- **MAE**: 0.47
- **MSE**: 0.81
- **MAPE**: 0.16

## Оптимальная конфигурация модели
В результате подбора гиперпараметров с использованием Optuna были определены следующие оптимальные значения:
- **max_depth**: 10
- **n_estimators**: 57
- **max_features**: 0.189
- **min_samples_split**: 2
- **min_samples_leaf**: 1

## Финальные метрики качества
После применения подобранных гиперпараметров достигнуты следующие показатели:
- **MAE**: 0.2343
- **MSE**: 0.2324
- **MAPE**: 0.0780

Идентификатор Production-модели в MLflow: `604afa9bb6164f78bc2268efa58d1794`

 
